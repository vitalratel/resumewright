name: Visual Tests - Custom Fonts

on:
  schedule:
    # Weekly on Sunday at 1am UTC (after main ci.yml weekly run)
    - cron: '0 1 * * 0'
  workflow_dispatch: # Allow manual trigger

# Cancel in-progress runs when a new workflow with the same group name is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  visual-tests-custom-fonts:
    name: Custom Fonts Visual Tests (UI + PDF)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        # Shard tests for parallel execution (target <3 minutes per shard)
        shard: [1/3, 2/3, 3/3]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Install wasm-pack
        uses: taiki-e/install-action@v2
        with:
          tool: wasm-pack

      - name: Build WASM modules
        run: pnpm build:wasm

      - name: Build extension
        run: pnpm --filter extension build

      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(pnpm list @playwright/test --json | jq -r '.[0].devDependencies["@playwright/test"].version')" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install --with-deps chromium

      - name: Install Playwright deps (cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: pnpm exec playwright install-deps chromium

      - name: Check if font fixtures exist
        id: check-fonts
        run: |
          if [ -d "packages/extension/tests/visual/fixtures/fonts" ] && [ "$(ls -A packages/extension/tests/visual/fixtures/fonts)" ]; then
            echo "fonts_exist=true" >> $GITHUB_OUTPUT
          else
            echo "fonts_exist=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if UI baselines exist
        id: check-ui-baselines
        run: |
          if [ -d "packages/extension/tests/visual/custom-fonts-ui.spec.ts-snapshots" ] && [ "$(ls -A packages/extension/tests/visual/custom-fonts-ui.spec.ts-snapshots)" ]; then
            echo "ui_baselines_exist=true" >> $GITHUB_OUTPUT
          else
            echo "ui_baselines_exist=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if PDF baselines exist
        id: check-pdf-baselines
        run: |
          if [ -d "packages/extension/tests/visual/custom-fonts-pdf.spec.ts-snapshots" ] && [ "$(ls -A packages/extension/tests/visual/custom-fonts-pdf.spec.ts-snapshots)" ]; then
            echo "pdf_baselines_exist=true" >> $GITHUB_OUTPUT
          else
            echo "pdf_baselines_exist=false" >> $GITHUB_OUTPUT
          fi

      - name: Run custom fonts UI visual tests (shard ${{ matrix.shard }})
        if: steps.check-fonts.outputs.fonts_exist == 'true' && steps.check-ui-baselines.outputs.ui_baselines_exist == 'true'
        run: xvfb-run --auto-servernum pnpm exec playwright test tests/visual/custom-fonts-ui.spec.ts --shard=${{ matrix.shard }}
        working-directory: packages/extension
        env:
          CI: true
        continue-on-error: false # Block PR merge if visual tests fail

      - name: Run custom fonts PDF visual tests (shard ${{ matrix.shard }})
        if: steps.check-fonts.outputs.fonts_exist == 'true' && steps.check-pdf-baselines.outputs.pdf_baselines_exist == 'true'
        run: xvfb-run --auto-servernum pnpm exec playwright test tests/visual/custom-fonts-pdf.spec.ts --shard=${{ matrix.shard }}
        working-directory: packages/extension
        env:
          CI: true
        continue-on-error: false # Block PR merge if visual tests fail

      - name: Upload visual diff images on failure
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: visual-diffs-custom-fonts-shard-${{ matrix.shard }}
          path: |
            packages/extension/test-results/**/*-diff.png
            packages/extension/test-results/**/*-actual.png
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: visual-test-results-custom-fonts-shard-${{ matrix.shard }}
          path: packages/extension/test-results/
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: playwright-report-custom-fonts-shard-${{ matrix.shard }}
          path: packages/extension/playwright-report/
          retention-days: 30
          if-no-files-found: ignore

      - name: Skip tests - no font fixtures
        if: steps.check-fonts.outputs.fonts_exist == 'false'
        run: |
          echo "‚ö†Ô∏è Custom font fixture files not found"
          echo "üìÅ Expected location: packages/extension/tests/visual/fixtures/fonts/"
          echo ""
          echo "üìù To add font fixtures:"
          echo "   1. Create directory: mkdir -p packages/extension/tests/visual/fixtures/fonts"
          echo "   2. Add test fonts: Roboto-Regular.ttf, OpenSans-Bold.woff, Lato-Italic.woff2"
          echo "   3. Commit fixtures: git add packages/extension/tests/visual/fixtures/"
          echo ""
          echo "‚ÑπÔ∏è Tests will be skipped until fixtures are added"

      - name: Skip tests - no UI baselines
        if: steps.check-fonts.outputs.fonts_exist == 'true' && steps.check-ui-baselines.outputs.ui_baselines_exist == 'false'
        run: |
          echo "‚ö†Ô∏è UI visual regression baselines not found"
          echo "üì∏ To generate UI baselines, run locally:"
          echo "   pnpm build:wasm"
          echo "   pnpm --filter extension build"
          echo "   pnpm exec playwright test tests/visual/custom-fonts-ui.spec.ts --update-snapshots"
          echo "   git add packages/extension/tests/visual/custom-fonts-ui.spec.ts-snapshots/"
          echo "   git commit -m 'chore: add custom fonts UI visual baselines'"

      - name: Skip tests - no PDF baselines
        if: steps.check-fonts.outputs.fonts_exist == 'true' && steps.check-pdf-baselines.outputs.pdf_baselines_exist == 'false'
        run: |
          echo "‚ö†Ô∏è PDF visual regression baselines not found"
          echo "üì∏ To generate PDF baselines, run locally:"
          echo "   pnpm build:wasm"
          echo "   pnpm --filter extension build"
          echo "   pnpm exec playwright test tests/visual/custom-fonts-pdf.spec.ts --update-snapshots"
          echo "   git add packages/extension/tests/visual/custom-fonts-pdf.spec.ts-snapshots/"
          echo "   git commit -m 'chore: add custom fonts PDF visual baselines'"

  comment-pr:
    name: Comment PR with Results
    runs-on: ubuntu-latest
    needs: visual-tests-custom-fonts
    if: github.event_name == 'pull_request' && always()

    steps:
      - name: Download all test results
        uses: actions/download-artifact@v6
        with:
          pattern: visual-test-results-custom-fonts-shard-*
          path: test-results/
          merge-multiple: true

      - name: Analyze test results
        id: analyze
        run: |
          # Count total tests, passed, and failed
          total_ui_tests=20
          total_pdf_tests=10

          # Check for diff images (indicates failures)
          failed_count=$(find test-results -name "*-diff.png" 2>/dev/null | wc -l)

          # Check if tests ran at all
          if [ -d "test-results" ] && [ "$(ls -A test-results)" ]; then
            tests_ran=true
            passed_count=$((total_ui_tests + total_pdf_tests - failed_count))
          else
            tests_ran=false
            passed_count=0
          fi

          echo "tests_ran=$tests_ran" >> $GITHUB_OUTPUT
          echo "passed=$passed_count" >> $GITHUB_OUTPUT
          echo "failed=$failed_count" >> $GITHUB_OUTPUT
          echo "total=$((total_ui_tests + total_pdf_tests))" >> $GITHUB_OUTPUT

      - name: Comment PR with test results
        uses: actions/github-script@v8
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const testsRan = '${{ steps.analyze.outputs.tests_ran }}' === 'true';
            const passed = parseInt('${{ steps.analyze.outputs.passed }}');
            const failed = parseInt('${{ steps.analyze.outputs.failed }}');
            const total = parseInt('${{ steps.analyze.outputs.total }}');

            let comment;

            if (!testsRan) {
              comment = `## üîç Visual Tests - Custom Fonts

              ‚ö†Ô∏è **Tests not run** - Missing font fixtures or baselines

              **Setup required:**
              1. Add font fixtures to \`packages/extension/tests/visual/fixtures/fonts/\`
              2. Generate baselines locally with \`--update-snapshots\`
              3. Commit baselines and fixtures to repository

              See [Visual Tests README](packages/extension/tests/visual/README.md) for details.
              `;
            } else if (failed === 0) {
              comment = `## ‚úÖ Visual Tests - Custom Fonts

              **All ${total} tests passed!** üéâ

              **Test Coverage:**
              - ‚úÖ Custom Fonts UI (20 tests)
                - Empty state, upload form, storage stats
                - Format badges (TTF, WOFF, WOFF2)
                - Progress states, error handling
                - Settings integration

              - ‚úÖ Custom Fonts PDF (10 tests)
                - WOFF decompression fidelity (95% threshold)
                - WOFF2 decompression fidelity (95% threshold)
                - Font subsetting validation
                - File size reduction checks

              **Performance:**
              - Test execution: Sharded 3 ways for parallel execution
              - Target: <3 minutes total
              `;
            } else {
              comment = `## ‚ùå Visual Tests - Custom Fonts

              **${failed}/${total} tests failed**

              **Results:**
              - ‚úÖ Passed: ${passed}
              - ‚ùå Failed: ${failed}

              **Action Required:**
              1. Download diff images from artifacts: \`visual-diffs-custom-fonts-shard-*\`
              2. Review visual differences
              3. If intentional changes:
                 - Update baselines with \`pnpm exec playwright test --update-snapshots\`
                 - Commit new baselines
              4. If unintentional:
                 - Fix the visual regression
                 - Re-run tests

              **Fidelity Threshold:** 95% similarity

              üì¶ Artifacts available:
              - Visual diffs: \`visual-diffs-custom-fonts-shard-*\`
              - Test results: \`visual-test-results-custom-fonts-shard-*\`
              - HTML report: \`playwright-report-custom-fonts-shard-*\`
              `;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  all-shards-passed:
    name: All Shards Passed
    runs-on: ubuntu-latest
    needs: visual-tests-custom-fonts
    if: always()

    steps:
      - name: Check shard results
        run: |
          if [ "${{ needs.visual-tests-custom-fonts.result }}" != "success" ]; then
            echo "‚ùå Visual tests failed in one or more shards"
            echo "üì¶ Check artifacts for diff images and detailed results"
            exit 1
          fi
          echo "‚úÖ All visual test shards passed"
