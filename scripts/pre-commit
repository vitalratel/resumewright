#!/bin/bash
# Pre-commit hook for ResumeWright
# Install: ln -s ../../scripts/pre-commit .git/hooks/pre-commit

set -e

echo "ğŸ” Running pre-commit checks..."

# Get staged Rust files
RUST_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(rs|toml)$' || true)

# Get staged TypeScript files  
TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)

# Rust checks (if Rust files changed)
if [ -n "$RUST_FILES" ]; then
  echo "ğŸ“¦ Rust files changed - running checks..."
  
  echo "  â†’ cargo fmt"
  cargo fmt --all -- --check || {
    echo "âŒ Rust formatting failed. Run: cargo fmt --all"
    exit 1
  }
  
  echo "  â†’ cargo clippy"
  cargo clippy --all-targets --all-features -- -D warnings || {
    echo "âŒ Clippy found issues"
    exit 1
  }
  
  echo "  â†’ cargo test"
  cargo test --workspace --quiet || {
    echo "âŒ Rust tests failed"
    exit 1
  }
  
  echo "  â†’ Rebuilding WASM..."
  pnpm build:wasm --quiet || {
    echo "âš ï¸  WASM build failed - continuing anyway"
  }
fi

# TypeScript checks (if TS files changed)
if [ -n "$TS_FILES" ]; then
  echo "ğŸ“ TypeScript files changed - running checks..."
  
  echo "  â†’ pnpm lint"
  pnpm lint || {
    echo "âŒ ESLint found issues. Run: pnpm lint --fix"
    exit 1
  }
  
  echo "  â†’ pnpm typecheck"
  pnpm typecheck || {
    echo "âŒ TypeScript type errors found"
    exit 1
  }
  
  echo "  â†’ pnpm test (unit tests only)"
  pnpm test --run || {
    echo "âŒ Tests failed"
    exit 1
  }
fi

echo "âœ… All pre-commit checks passed!"
